# MBC（メモリバンクコントローラ）の仕組み
ここまでで、ROMのヘッダ情報を解析しました。ヘッダーの先頭4Byteは以下の様になっていたと思います。

```
0100 : 00 // NOP
0101 : C3 // JP
0102 : 50 // 0x50 下位8bit
0103 : 01 // 0x01 上位8bit
```

つまり、0x0150からがROMのプログラム本体になります。一方で、ゲームボーイのアドレスバスは16bitしかありません。したがって、単純なアドレス指定であった場合、利用可能なメモリ空間に制限が生じてしまい、最大でも64KByteしか利用できません。単純な処理にのみ限定すれば十分な領域に思えるかもしれませんが、グラフィックデータを考えれば明らかに足りません。何とかしてROMを拡張する必要があります。

そこで、ゲームボーイにはそのカートリッジ内部にMBCというチップが入っています。このチップにより、利用できるアドレス空間を拡張することが可能で、初代ゲームボーイであれば理論上最大で2MByte近くまで容量を拡大できました。

エミュレータを作成する場合、このMBCの仕組みを理解することは必須となります。実機エミュレータであれば実際にカートリッジと接続するため、カートリッジ内のMBCを利用することが可能であり、仕組みをある程度理解するだけで良いでしょう。しかしながら、全てをソフトウェア上でエミュレートしたい場合は、仕組みを完璧に理解した上でこれを再現する必要があるので大変だと思います。更に、MBCにはいくつかの種類があるため、ROMのヘッダ情報（@0147h）をもとにMBCチップの種類を判定し、これに合わせてエミュレートする必要があるのですが、今回はMBC1のみに対応してエミュレータを製作します。

## MBC1チップ内のレジスタについて
MBC1チップ内には、RAMの有効/無効を設定したり、バンクを指定するためのレジスタが複数存在しています。そして、それらのレジスタを選択するためのピンが、カートリッジ端子のA13、A14、A15と接続されています。ピンA0～A15は、アドレスを指定するためのもので、16bitのサイズとなっています。この16bitの最上位から3bitのみがMBC1チップと接続されているため、それらよりも下位のbitはどんな値でも良いことになります。

例えば、RAMを有効にする際は以下の通りにMAC1内のゲートレジスタ（8bit）を指定し、そこの下位4bitに0b0101という値を書き込むことで設定できます。その他の値では無効になり、また上位4bitは無視されます。

1. A0～A15ピンに、アドレス0000h～1FFFh（つまり、最上位bitが000）のいずれかの値を指定
2. WR=0,RD=1,CS=0（全てピンの名称、負論理）に設定
3. 0x0Aを書き込む

こうすることにより、指定されたバンクのRAM（0xA000～0xBFFF）に読み書きが可能となります。

以降に説明するMBC1チップの使用方法も、上記方法と同様です。ネット上に公開されている資料ですと、MBCチップとアドレスピンの関係について触れていないものもあり、少々混乱するかも知れません。

## MBC1 (max 2MByte ROM and/or 32KByte RAM)
MBC1の仕様は以下の通りとなっています。

### 0000-3FFF - ROM Bank 00 (Read Only)
このエリアには、常にカートリッジROMの最初の16KByteが含まれています。特にバンクの切り替えを行うことなく利用できる固定のアドレス空間となります。

早速覗いてみましょう。

```c:
void dump_bank00() {
  char buf[16];
  Serial.println("= mbc1 bank 00 dump =");
  for (int j = 0; j < 0x3ef; j++) {
    sprintf(buf, "%04X : ", j * 16);
    Serial.print(buf);
    for (int i = 0; i < 16; i++) {
      sprintf(buf, "%02X ", get_byte(i + 16 * j));
      Serial.print(buf);
    }
    Serial.println("");
  }  
}
```

上記関数を用意して実行してみます。

```
= mbc1 bank 00 dump =
0000 : FF 00 00 00 00 00 00 00 FF 00 00 00 00 00 00 00 
0010 : FF 00 00 00 00 00 00 00 FF 00 00 00 00 00 00 00 
0020 : FF 00 00 00 00 00 00 00 FF 00 00 00 00 00 00 00 
0030 : FF 00 00 00 00 00 00 00 C3 80 F0 00 00 00 00 00 
0040 : C3 AC 0A 00 00 00 00 00 FF 00 00 00 00 00 00 00 
0050 : C3 88 0D 00 00 00 00 00 C3 A7 0B 00 00 00 00 00 
0060 : D9 00 00 00 00 00 00 00 FF 01 FF 28 5F 24 FF FF 
0070 : FF 62 FF C4 76 80 7F 02 D5 0F FF 01 E6 23 DF FF 
0080 : 00 7F 85 FF 54 7F 34 BB 92 FF 55 DD 91 4F 08 DF 
0090 : FF 68 FD 04 97 5C DD 9C DD 60 C9 20 7F 04 2F 6F 
00A0 : FF 08 DB 53 D6 4A DB 83 FB 89 D6 20 D5 E6 FB FF 
00B0 : FF 40 FE 88 FF 00 BF 80 7E 16 71 85 4E 80 DF FF 
00C0 : FF 52 77 09 ED 87 D7 F0 FF 15 FD 40 DF 41 FF FF 
00D0 : FF 8E 7D C9 FF 1D F7 B9 EF 8E 7E 4A FF 61 FF FF 
00E0 : FF 06 FF 11 E3 00 F7 42 7F 5A EF 20 F9 56 77 BF 
00F0 : FF 84 EA 91 DF 38 FF 59 FF 02 F7 44 FE 4A FD DF 
0100 : 00 C3 50 01 CE ED 66 66 CC 0D 00 0B 03 73 00 83 
0110 : 00 0C 00 0D 00 08 11 1F 88 89 00 0E DC CC 6E E6 
0120 : DD DD D9 99 BB BB 67 63 6E 0E EC CC DD DC 99 9F 
0130 : BB B9 33 3E 50 4F 4B 45 4D 4F 4E 20 47 52 45 45 
0140 : 4E 00 00 00 30 31 03 03 04 03 00 33 01 9B F5 47 
0150 : C3 DA 09 F0 B8 F5 3E 03 E0 B8 EA 00 20 CD 00 40 
0160 : F1 E0 B8 EA 00 20 C9 AF E0 0F F0 FF 47 CB 87 E0 
0170 : FF F0 44 FE 91 20 FA F0 40 E6 7F E0 40 78 E0 C1 
0180 : C9 F0 40 CB FF E0 40 C9 AF 21 00 C3 06 A0 22 05 
0190 : 20 FC C9 3E A0 21 00 C3 11 04 00 06 28 77 19 05 

省略

3FA0 : F9 7A F2 7F E2 7F F9 79 84 7D BF 7F 9D 7F AD 7F 
3FB0 : A0 79 F9 7E B0 7E 09 7F 4E 7F 8E 7F 90 7F 50 7F 
3FC0 : 82 7F C9 7F A0 79 F9 7E B0 7E 09 7F 4E 7F 8E 7F 
3FD0 : 90 7F 50 7F 82 7F C9 7F 10 7F 52 7B 04 FF 48 FF 
3FE0 : FE D7 49 FF 24 FD 01 7F C0 FF 04 BB 05 FF 03 FF 
3FF0 : 7B DB 20 FF 22 BB 80 7F 5C DD 95 BF 00 EF 01 7F 
```

結構時間がかかりましたが、バンク00の全ての内容を入手することができました。これまでの解析結果から、0h～FFhまではゲームボーイ本体内部のROMに書き込まれたブートプログラムのはずなので、これは何らかのゴミを拾っているのでしょう。また、ヘッダはきちんと読み込めていることが分かります。今回重要なのは、0150h以降です。これで逆アセンブルをすればソースコードが追える訳ですね。

### 4000-7FFF - ROM Bank 01-7F (Read Only)
この領域には、さらに16KByteのROMバンクのいずれかを含めることができます。最大125ROMバンク（ほぼ2MByte）のアドレス指定が可能です。後述するように、バンク番号20h、40h、60hは使用できないため、125バンクという奇数バンクになります。

### A000-BFFF - RAM Bank 00-03, if any (Read/Write)
この領域は、カートリッジに外部RAMがある場合、そのアドレスに使用されます。外部RAMはバッテリーバッファリングされていることが多く、ゲームボーイの電源が切れても、カートリッジがゲームボーイから外されても、ゲームポジションやハイスコアテーブルを保存することができます。使用可能なRAMのサイズは以下の通りです。2KByte（A000-A7FF）、8KByte（A000-BFFF）、32KByte（A000-BFFFの8Kバンクが合計で４個）です。

### 0000-1FFF - RAM Enable (Write Only)
外部RAMを読み書きする前に、このアドレス空間に書き込んで、外部RAMを有効にする必要があります。Gameboyのパワーダウン時に外部RAMの内容が損傷しないように、アクセス後は外部RAMを無効にすることをお勧めします。通常、以下の値が使用されます。

```
00h  Disable RAM (default)
0Ah  Enable RAM
```

実際には、下位4ビットが0Ahの値の場合はRAMを有効にして、それ以外の値はRAMを無効にする、ということになる。

### 2000-3FFF - ROM Bank Number (Write Only)
このアドレス空間に書き込むと、ROMのバンク番号の下位5ビット（01～1Fhの範囲）を選択します。00hを書き込むと、MBCはそれを01hのバンクにも変換します。0000-3FFFを読めば常にROMバンク00hに直接アクセスできるので、今のところ支障はありません。しかし、（下記のレジスタで上位ROMバンクのビットを指定した場合）バンク20h、40h、60hでも同じことが起こります。これらのROMバンクをアドレス指定しようとすると、代わりにバンク21h、41h、61hが選択されます。

### 4000-5FFF - RAM Bank Number - or - Upper Bits of ROM Bank Number (Write Only)
この2ビットレジスタは、現在のROM/RAMモードに応じて、00-03hの範囲でRAMバンクを選択するか、ROMバンク番号の上位2ビット（5-6ビット）を指定するために使用されます。(下記参照)

### 6000-7FFF - ROM/RAM Mode Select (Write Only)
上記レジスタの2ビットをROMバンクの上位2ビットとして使用するか、RAMバンク番号として使用するかを選択する1ビットレジスタです。

```
00h = ROM Banking Mode (up to 8KByte RAM, 2MByte ROM) (default)
01h = RAM Banking Mode (up to 32KByte RAM, 512KByte ROM)
```

モード0ではRAMバンク00hのみ、モード1ではROMバンク00-1Fhのみ使用可能であり、プログラムは自由に両モードを切り替えることができます。


