https://pixelbits.16-b.it/GBEDG/ppu/

翻訳中

# PPUの仕組み
## はじめに
PPU（Picture Processing Unitの略）とは、ゲームボーイで画面に表示されるすべての情報を処理している部分です。CPUの次に重要なパーツですが、複雑さではCPUを圧倒的に上回ります。PPUはもっと厄介で、明確なドキュメントがないため、ここでは簡単で素早く理解できるような要約を提供したいと思います。

## 警告の言葉

このドキュメントは100％正確ではありません。様々な情報源から得た情報と、私がエミュレータを開発している間に個人的に経験したことを組み合わせたものです。もし何かおかしな点があれば、Discord (Optix™#1337) で私個人と連絡を取るか、PRを作成してください。

また、このドキュメントの現在のバージョンはDMGエミュレーションにのみ焦点を当てており、CGBやSGBの機能は考慮されていません。

## 基本情報
### 画面について

初代DMGゲームボーイの画面は160x144ピクセルのLCDで、最大4色のグレーを表示することができます。DMGでは緑色で表示されますが、多くのエミュレータではカスタムカラーパレットに対応しており、ユーザーが手動で表示する色を設定することができます。
タイルの概念

画面の解像度は160×144ピクセルだが、ピクセルに直接「書き込む」ことはできない。ゲームボーイでは、8×8ピクセルのタイルしか表示できません。これは多かれ少なかれ「8×8ピクセルの固定テクスチャ」であり、画面上に一定のグリッドで配置することができる。これにはいくつかの例外がありますが、それは後で説明します。



![8x8](https://github.com/asaioe99/Gameboy/blob/main/img/8x8_tile.png)

### 画素データ

DMGの初代Gameboyは4色のパレットにしか対応していないため、1画素の色データを格納するのに2ビットが必要となる。そのため、Gameboyでは「2BPP」（2 bit per pixel）と呼ばれる方式で画像データを記録している。

Gameboyの2BPPフォーマットでは、2バイトで8画素の列を構成する。1バイト目の各ビットと2バイト目の同じ位置のビットを組み合わせて色番号を計算します。ここでは、0xA5 0xC3 を例として説明します。

![gb_2bpp](https://github.com/asaioe99/Gameboy/blob/main/img/gb_2bpp.png)

メモリ上のタイルは、上記の方法で符号化された16バイトで格納される。最初の2バイトが8画素の1行目、次の2バイトが2行目、といった具合に表現される。

## ディスプレイのレイヤー
Gameboyのディスプレイは、「背景」「ウィンドウ」「スプライト」という3つのレイヤーを使ってグラフィックを表示します。

### 背景
背景は、32×32ピクセル（256×256ピクセル）のタイルで、この中にタイルを配置することができます。ただし、GameBoyでは、20×18ピクセル（160×144ピクセル）分の背景しか表示できません。この部分を「ビューポート」と呼びます。どの部分を表示するかは、SCXとSCYレジスタ（後述）を使って決めることができ、プログラムで設定することができる。これらのレジスタの値は、ビューポートが背景の左と上の境界線からそれぞれ何ピクセルオフセットされているかを決定する。ビューポートが背景のボーダーを超えると、それぞれ左/上に折り返される。

![grid_bg](https://github.com/asaioe99/Gameboy/blob/main/img/grid_bg.png)

### ウィンドウ

ウィンドウは背景と同じで、32x32のタイルグリッドで、タイルを配置することができます。しかし、これは背景の上にある一種の「オーバーレイ」と見ることができ、その位置はWXとWYレジスタを使って決定することができます（これについても後ほど説明します）。

![grid_win](https://github.com/asaioe99/Gameboy/blob/main/img/grid_win.png)

#### WXレジスタとWYレジスタ

WYレジスタは、2つのレジスタのうちより単純なものです。メモリアドレス$FF4Aを使用して、プログラムは、ウィンドウの最上部の境界を配置するY位置を設定することができます（0は最上部を意味します）。

メモリ・アドレス$FF4BにあるWXレジスタには、少し奇妙な点があります。ウィンドウを画面の左端に配置するには、レジスタに値7を書き込まなければなりません。7より小さい値は、奇妙なエッジケースを発生させますが、ここではまだ文書化されていません。しかし、7以下のWX値を使用するゲームでは、ほとんど無視することができます。

事実上、ウィンドウが表示されるべき水平位置は、WX - 7で計算できます。たとえば、WX 値が 6 の場合（前述のエッジケースを無視）、左端の列のピクセルが画面外に置かれ、2 列目でウィンドウのレンダリングが開始されます（この例を参照してください）。
